\input{../slides/common/slides_common}

\newif\ifbook
\input{../shared/chisel}

% TikZ for diagrams
\usepackage{tikz}
\usetikzlibrary{positioning, arrows.meta}

% Optional visual tweaks
\tikzset{
    >=Stealth,
    every node/.style={rounded corners=2pt}
}

\title{Formal Verification}
\author{Martin Schoeberl}
\date{\today}
\institute{Technical University of Denmark\\
Embedded Systems Engineering}

\begin{document}

\begin{frame}
\titlepage
\end{frame}




\begin{frame}[fragile]{Outline}
\begin{itemize}

\item What is formal verification
\item How can it be used to verify digital designs
\item Chisel Formal

\end{itemize}
\end{frame}

\begin{frame}[fragile]{The New New Product Development Game}
\begin{itemize}
\item by Hirotaka Takeuchi and Ikujiro Nonaka
\item Paper that started the Scrum movement (mid 80s)
\begin{itemize}
\item Move like a rugby team together to reach the aim
\item Instead of a relay race, where runners wait for arrival
\end{itemize}
\item In production, not in software development
\item Observing mostly Japanese, some USA companies
\item Examined multinational companies
\begin{itemize}
\item Fuji-Xerox, Canon, Honda, NEC, Epson, Brother, 3M, Xerox, and Hewlett-Packard
\end{itemize}
\item Available at \href{https://hbr.org/1986/01/the-new-new-product-development-game}{Harward Business Review}
\item Easy reading, give it a try
\end{itemize}
\end{frame}

\begin{frame}[fragile]{New product development processes}
\begin{enumerate}
\item Built-in instability
\item Self-organizing project teams
\item Overlapping development phases
\item ``Multilearning''
\item Subtle control
\item Organizational transfer of learning
\end{enumerate}
\end{frame}

\begin{frame}[fragile]{When is Simulation and Testing Enough?}
\begin{itemize}
\item How much do you need to test?
\item How confident are you?
\begin{itemize}
\item Did you test the corner cases?
\item An issue when the same person did design and tests
\end{itemize}
\item We cannot cover all input possibilities
\item Except in trivial cases
\begin{itemize}
\item Parameters might help
\item Cover all cases for a 4-bit ALU
\item Assume the design also works for 32 bits 
\end{itemize}
\item Any other option?
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Assertions in Chisel}
\begin{itemize}
\item An Assertion statement states assumptions about a program
\item You have seen \code{assert} in Scala in the first lab
\item Can also be used in Chisel
\item Assertion is checked during simulation time
\item Syntax:
\begin{chisel}
  io.sum := io.a + io.b
  assert(io.sum === io.a + io.b, "error message")
\end{chisel}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Assert Example}
\shortlist{../code/assert.txt}
\end{frame}

\begin{frame}[fragile]{\code{require} vs \code{assert}}
\begin{itemize}
\item Chisel \code{assert} checks value in simulation
\begin{itemize}
\item Emits non-synthesizable Verilog
\item Using a Chisel expression that results in a \code{Bool}
\item Can also have a failure message
\end{itemize}
\item Scala \code{assert} checks value at circuit construction
\item Using a Scala expression that results in a \code{Boolean}
\item Better use Scala's \code{require}
\item \code{require} is used for input sanity checking
\shortlist{../code/fifo_abstract.txt}
\end{itemize}
\end{frame}


\begin{frame}[fragile]{Formal Verification}
\begin{itemize}
\item Simulation explores (only) some test cases
\item Formal verification explores \emph{all} possible behaviors
\item Uses SAT/SMT solvers to prove properties
\begin{itemize}
\item As bounded model checking (BMC)
\end{itemize}
\item Finds corner cases that simulation might miss
\item Sounds a bit too good to be true, right?
\begin{itemize}
\item Might take a long time, days or more
\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Properties in Formal Verification}
\begin{itemize}
    \item Properties describe what must always hold
    \item Types of properties:
    \begin{itemize}
        \item Safety: something bad never happens
        \item Liveness: something good eventually happens
    \end{itemize}
    \item Examples:
    \begin{itemize}
        \item FIFO never overflows (safety)
        \item Every request is eventually granted (liveness)
    \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}[fragile]{Chisel Formal}
\begin{itemize}
\item Extension of \code{ChiselTest} by Kevin Laeufer
\begin{itemize}
\item Part of his \href{https://www2.eecs.berkeley.edu/Pubs/TechRpts/2024/EECS-2024-157.pdf}{PhD} at UC Berkeley
\end{itemize}
\item Chisel \code{assert} is \emph{formally} checked
\begin{itemize}
\item Up to a bound
\end{itemize}
\item If the proof fails, Chisel formal provides a counter example (as VCD waveform)
\item Install the open \href{https://github.com/Z3Prover/z3}{Z3} theorem prover
\begin{itemize}
\item With your favorite packet manager, e.g., brew, apt,...
\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Chisel Formal}
\begin{itemize}
\item Import the library
\shortlist{../code/formal_import.txt}
\item Formal is part of ChiselTest (add treat \code{Formal})
\shortlist{../code/formal_class.txt}
\item Use \code{verify} instead of \code{test}
\shortlist{../code/formal_assert.txt}
\item Have the asserts in your module
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Access the History}
\begin{itemize}
\item \code{past()} allows us to make assamptions over time
\item If \code{in} was 10 last cycle, then \code{out} must be 11 now
\shortlist{../code/formal_past.txt}
\item A signal must stay stable, be the same as in the last cycle
\shortlist{../code/formal_stability.txt}
\item With \code{past(x)} call we get the value of \code{x} from the last clock cycle
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Past Example}
\shortlist{../code/formal_past_example.txt}
\end{frame}

\begin{frame}[fragile]{Assumptions}
\begin{itemize}
\item We can limit the search space
\item Assuming that some (input) signals have restricted values
\item Assume that a signal will never be zero:
\shortlist{../code/formal_assume.txt}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Assume Example}
\shortlist{../code/formal_assume_example.txt}
\end{frame}

\begin{frame}[fragile]{More Functions}
\begin{itemize}
\item Synthactic sugar for \code{past}
\item changed
\item fell
\item rose
\item stable
\item See \href{https://www.javadoc.io/static/edu.berkeley.cs/chiseltest_2.12/0.5.5/chiseltest/formal/index.html}{Javadoc}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Limits to Bounded Model Checking}
\begin{itemize}
\item BMC will check your design only for the first N cycles
\item Can fail in clock cycle N+1
\item Only checks your assertions
\item They need to be correct
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Other Options}
\begin{itemize}
\item Synopsys and Cadence have for sure formal verifiers
\item \href{https://github.com/YosysHQ/sby}{Sby} is a free, open-source verification tool
\item Part of YosysHQ
\item See Matt Venn \href{https://www.youtube.com/watch?v=B1KX2rFJqVE}{explaining it}
\item \href{https://symbiyosys.readthedocs.io/en/latest/index.html}{SymbiYosys (sby) Documentation}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Next Week}
\begin{itemize}
\item Guest lecture by Frans Skarman
\item On Spade, a new HDL
\item Frans developed also Surfer, the new waveform viewer
\begin{itemize}
\item Check out the VSC plugin (show it)
\end{itemize}
\item Please \href{https://docs.spade-lang.org/agile/quick_setup.html}{setup Spade}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Summary}
\begin{itemize}
\item Formal verification is the next step in testing
\item It is another tool in your toolbox
\item Easy to include in your continuous integration on GitHub
\item I have prepared some \href{https://github.com/schoeberl/agile-hw/tree/main/lab8}{lab} exercises for you
\end{itemize}
\end{frame}


\end{document}

\begin{frame}[fragile]{XXX}
\begin{itemize}
\item xxx
\item xxx
\item xxx
\begin{itemize}
\item xxx
\end{itemize}
\item xxx
\item xxx
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Title}
\begin{itemize}
\item abc
\end{itemize}
\end{frame}
