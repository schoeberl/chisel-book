\input{../slides/common/slides_common}

\newif\ifbook
\input{../shared/chisel}

% TikZ for diagrams
\usepackage{tikz}
\usetikzlibrary{positioning, arrows.meta}

% Optional visual tweaks
\tikzset{
    >=Stealth,
    every node/.style={rounded corners=2pt}
}

\title{Co-Simulation and Formal Verification}
\author{Martin Schoeberl}
\date{\today}
\institute{Technical University of Denmark\\
Embedded Systems Engineering}

\begin{document}

\begin{frame}
\titlepage
\end{frame}




\begin{frame}[fragile]{Outline}
\begin{itemize}
\item Agile is about test driven development
\item Co-Simulation
\item Formal verification
\item Your project status
\item Shorter lecture today
\item Need to catch a flight
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Co-Simulation}
\begin{itemize}
\item Write a \emph{golden} model for your hardware
\item Run the hardware and the model in parallel
\item Compare the output
\item Input is sometimes random, or constraint random
\item Who is writing the reference model?
\item Same error in model and implementation?
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Reference Model}
\begin{itemize}
\item A Java or Scala program (for Chisel)
\item A C/C++ model
\item Matlab/Simulink
\item Is it cycle accurate?
\item How to compare when not cycle accurate
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Game of Live Example}
\begin{itemize}
\item \href{https://en.wikipedia.org/wiki/Conway\%27s_Game_of_Life}{Conway's Game of Life}
\item Any live cell with two or three live neighbors survives.
\item Any dead cell with three live neighbors becomes a live cell.
\item All other live cells die in the next generation. Similarly, all other dead cells stay dead.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Game of Live Co-Simulation}
\begin{itemize}
\item An exercise in the Java Introduction to programming
\item The problem is highly parallel
\item I will show you a Chisel (and Java) implementation
\item FPGA version is extremely fast compared to the Java implementation
\item It contains co-simulation
\item \url{https://github.com/schoeberl/game-of-live}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Example: Processor Design}
\begin{itemize}
\item Write an ISA simulation
\item Who did Computer Architecture?
\item You wrote a RISC-V ISA simulation
\item You might do a RISC-V in January
\item There, you should do the co-simulation
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Cycle Accurate Example}
\begin{itemize}
\item \href{https://github.com/schoeberl/lipsi}{Lipsi} processor
\item Tiny processor core
\item Showing it as Chisel motivation
\item Has a cycle-accurate SW model in Scala
\item Let us explore it now
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Non-Cycle Accurate Example}
\begin{itemize}
\item RISC-V core \href{https://github.com/schoeberl/wildcat}{Wildcat}
\item Shall be a teaching reference
\item Several implementations
\begin{itemize}
\item ISA simulation (in Scala)
\item Pipelines: 3, 4, and 5 stages
\item Single cycle (= ISA simulation in Chisel)
\item Multi-cycle planned
\end{itemize}
\item What to compare?
\item How/when to compare?
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Non-Cycle Accurate Example}
\begin{itemize}
\item What to compare:
\begin{itemize}
\item All data goes at some point through the register file
\item Just compare register file content
\item Not so much state (compared to memory content)
\end{itemize}
\item When to compare:
\begin{itemize}
\item One could track updates each clock cycle and advance only on a change
\item When to stop? Timeout if one of the two \emph{hangs}
\item Compare register file content at the end
\item We had this in the Computer Architecture lab
\end{itemize}
\item Explore it now
\end{itemize}
\end{frame}

\begin{frame}[fragile]{When is it Enough?}
\begin{itemize}
\item How much do you need to test?
\item How confident are you?
\item We cannot cover all input possibilities
\item Except in trivial cases
\begin{itemize}
\item Parameters might help
\item Cover all cases for a 4-bit ALU
\item Assume the design also works for 32 bits 
\end{itemize}
\item Any other option?
\end{itemize}
\end{frame}

\begin{frame}[fragile]{Assertions in Chisel}
\begin{itemize}
\item An Assertion statement states assumptions about a program
\item You have seen \code{assert} in Scala in the first lab
\item Can also be used in Chisel
\item Assertion is checked during simulation time
\item Syntax:
\begin{chisel}
  io.sum := io.a + io.b
  assert(io.sum === io.a + io.b, "error message")
\end{chisel}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{\code{require} vs \code{assert}}
\begin{itemize}
\item Chisel \code{assert} checks value in simulation
\begin{itemize}
\item Emits non-synthesizable Verilog
\item Using a Chisel expression that results in a \code{Bool}
\item Can also have a failure message
\end{itemize}
\item Scala \code{assert} checks value at circuit construction
\item Using a Scala expression that results in a \code{Boolean}
\item Better use Scala's \code{require}
\item \code{require} is used for input sanity checking
\shortlist{../code/fifo_abstract.txt}
\end{itemize}
\end{frame}


\begin{frame}[fragile]{Formal Verification}
\begin{itemize}
\item Simulation explores (only) some test cases
\item Formal verification explores \emph{all} possible behaviors
\item Uses SAT/SMT solvers to prove properties
\item Finds corner cases that simulation might miss
\item Sounds a bit too good to be true, right?
\end{itemize}
\end{frame}

\begin{frame}{Properties in Formal Verification}
\begin{itemize}
    \item Properties describe what must always hold
    \item Types of properties:
    \begin{itemize}
        \item Safety: something bad never happens
        \item Liveness: something good eventually happens
    \end{itemize}
    \item Examples:
    \begin{itemize}
        \item FIFO never overflows (safety)
        \item Every request is eventually granted (liveness)
    \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}[fragile]{Chisel Formal}
\begin{itemize}
\item Extension of \code{ChiselTest} by Kevin Laeufer
\begin{itemize}
\item Part of his \href{https://www2.eecs.berkeley.edu/Pubs/TechRpts/2024/EECS-2024-157.pdf}{PhD} at UC Berkeley
\end{itemize}
\item Chisel \code{assert} is \emph{formally} checked
\item Use \code{verify} instead of \code{test}
\shortlist{../code/formal_assert.txt}
\item Install the open \href{https://github.com/Z3Prover/z3}{Z3} theorem prover for next week
\begin{itemize}
\item With your favorite packet manager, e.g., brew, apt,...
\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[fragile]{XXX}
\begin{itemize}
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\end{itemize}
\end{frame}

\begin{frame}[fragile]{XXX}
\begin{itemize}
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\end{itemize}
\end{frame}

\begin{frame}[fragile]{XXX}
\begin{itemize}
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\item xxx
\end{itemize}
\end{frame}





\begin{frame}[fragile]{Summary}
\begin{itemize}
\item Co-simulation as advanced version of testing
\item Formal verification is another tool
\item Today's lab brought to you by Javad
\item Next week, maybe a formal verification lab
\item Now it is your turn to present
\end{itemize}
\end{frame}


\end{document}

\begin{frame}[fragile]{Title}
\begin{itemize}
\item abc
\end{itemize}
\end{frame}
